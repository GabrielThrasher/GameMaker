{% extends "layout.html" %}
{% block title %}Matchups - Game Maker{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

<style>
  #matchup-container {
    font-family: 'Montserrat', sans-serif;
    padding: 20px;
    background-color: #f9f9f9;
  }

  .matchup-header-container {
    text-align: left;
    margin-bottom: 20px;
  }

  .matchup-title {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
  }

  .toggle-wrapper {
    display: flex;
    align-items: left;
    justify-content: left;
    gap: 12px;
    margin-top: 12px;
  }

  /* Toggle Labels */
  .toggle-label {
    font-size: 14px;
    color: #1D428A;
    font-weight: 600;
  }

  /* iOS Style Toggle */
  .ios-toggle {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }

  .ios-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    background-color: #ccc;
    border-radius: 34px;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    transition: 0.4s;
  }

  .slider::before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: 0.4s;
  }

  input:checked + .slider {
    background-color: #4caf50;
  }

  input:checked + .slider::before {
    transform: translateX(22px);
  }

  #matchup-container h1 {
    text-align: center;
    margin-bottom: 30px;
  }

  .main-wrapper {
    display: flex;
    gap: 40px;
    align-items: flex-start;
    justify-content: center;
    flex-wrap: wrap;
  }

  .all-teams-box {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    width: 400px;
    max-height: 600px;
    overflow-y: auto;
    padding: 20px;
  }

  .all-teams-box h2 {
    text-align: center;
    margin-bottom: 15px;
    color: #1D428A;
  }

  .team-list-column {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .team-card {
    width: 350px;
    padding: 10px;
    margin-bottom: 8px;
    background-color: #f5f5f5;
    border-radius: 12px;
    text-align: center;
    font-weight: 600;
    cursor: grab;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
  }

  .right-panel {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
  }

  .court-area {
    width: 90%;
    max-width: 800px;
    height: 400px;
    background-image: url('https://www.wallmonkeys.com/cdn/shop/products/49338347-LRG_530x.jpg?v=1578660927');
    background-position: center;
    background-repeat: no-repeat;
    background-size: contain;
    border-radius: 30px;
    overflow: hidden;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 50px;
  }

  .drop-zone {
    width: 35%;
    height: 150px;
    border: 2px dashed #1D428A;
    border-radius: 12px;
    background-color: rgba(255,255,255,0.8);
    font-weight: bold;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
  }

  #predict-btn {
    padding: 12px 32px;
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    background-color: #1D428A;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #predict-btn:hover {
    background-color: #163269;
  }

  #matchup-date {
    padding: 10px 14px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    cursor: pointer;
    min-width: 150px;
    box-sizing: border-box;
  }

  #controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
</style>

<div id="matchup-container">

  <div class="matchup-header-container">
    <h2 style="color: #1D428A;" class="matchup-title">Choose your matchup</h2>
    
    <div class="toggle-wrapper">
      <span class="toggle-label">NBA</span>
      
      <label class="ios-toggle">
        <input type="checkbox" id="league-toggle" />
        <span class="slider"></span>
      </label>
      
      <span class="toggle-label">NCAA</span>
    </div>
  </div>
  
  <div class="main-wrapper">
    <div class="all-teams-box">
      <h2>All Teams</h2>
      <div class="team-list-column" id="team-list-column">
       
      </div>
    </div>

    <div class="right-panel">
      <div class="court-area">
        <div class="drop-zone" id="team1-drop">Drop Team 1 Here</div>
        <div class="drop-zone" id="team2-drop">Drop Team 2 Here</div>
      </div>

      <div id="controls">
        <label for="date-select" style="font-weight: 600;">SELECT DATE</label>
    <div style="display: flex; gap: 1em; margin-bottom: 1em; margin:auto ;">
      <input 
        type="date" 
        name="game_date" 
        id="date-select" 
        value = '2024-10-22'
        required
        style="flex-grow: 1; padding: 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; max-width: 200px;"
      >
      <label for="model-select" style="font-weight: 600;align-content: center;">Select Prediction Method</label>
    <select name="model-select" id="model-select" style="
      width: 180px;
      padding: 10px 16px;
      background-color: #ffffff;
      color: rgb(0, 0, 0);
      font-weight: 600;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    ">
      <option value="deterministic">Base Model</option>
      <option value="simulation">Simulation</option>
    </select>
    
      <button type="button" onclick="retrieveMatchups()" style="
        padding: 10px 16px;
        background-color: #1D428A;
        color: white;
        font-weight: 600;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      ">RETRIEVE</button>
      <button type="button" id="predict-button" onclick="predictGames()"style="
        padding: 10px 16px;
        background-color: #1D428A;
        color: white;
        font-weight: 600;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      "
      >PREDICT</button>
      </div>
    </div>
  </div>

  <div id="games-table-container" style="margin-top: 40px;"></div>
<div id="predictions-table-container"></div>
<div id="stats-table-container"></div>
</div>



<script>
  function renderGameTable(data, prediction='None') {
    let total_games = 0;
    const container = document.getElementById('games-table-container')
    container.innerHTML = '';
    for (const [date, games] of Object.entries(data.games)) {
      const heading = document.createElement('h3');
      heading.textContent = `Games on ${date}`;
      heading.style.cssText = "margin-top: 20px; font-weight: 600; text-align: center;";
      container.appendChild(heading);


      const table = document.createElement('table');
      table.id = `table-${date}`
      table.className = 'game-table'
      table.style.cssText = "width: 100%; border-collapse: collapse; font-family: 'Montserrat', sans-serif; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px;";


      const thead = document.createElement('thead');
      let newHTML = `
        <tr style="background-color: #1D428A; color: white;">
          <th style="padding: 12px; border: 1px solid #ddd;">Home</th>
          <th style="padding: 12px; border: 1px solid #ddd;">Home W–L</th>
          <th style="padding: 12px; border: 1px solid #ddd;">Away</th>
          <th style="padding: 12px; border: 1px solid #ddd;">Away W–L</th>
      `;
      if (prediction != 'None') {
        newHTML += `
            <th style="padding: 12px; border: 1px solid #ddd;">Prediction</th>
            <th style="padding: 12px; border: 1px solid #ddd;">Winner</th>
        `;
      }
      if (prediction == 'simulation') {
        newHTML += `
            <th style="padding: 12px; border: 1px solid #ddd;">Confidence %</th>
            <th style="padding: 12px; border: 1px solid #ddd;">Confidence Interval</th>
        `;
      }

      newHTML += `</tr>`;


      thead.innerHTML = newHTML;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      games.forEach(game => {
        const row = document.createElement('tr');
        row.id = game.id
        row.style.backgroundColor = '#f9f9f9';
        row.setAttribute('draggable', true);

        newHTML = `
          <td id="${game.home_id}" style="padding: 12px; border: 1px solid #ddd;">${game.home}</td>
          <td style="padding: 12px; border: 1px solid #ddd;">${game.home_record}</td>
          <td id="${game.away_id}" style="padding: 12px; border: 1px solid #ddd;">${game.away}</td>
          <td style="padding: 12px; border: 1px solid #ddd;">${game.away_record}</td>
        `;
        if (prediction != "None") {
          let background_color = game.prediction === game.winner? '#00FF52' : '#fc0511';
          if (game.prediction == "Undefined") {
            background_color = '#FFFF00';
          }
          newHTML += `
            <td style="padding: 12px; border: 1px solid #ddd; background-color: ${background_color};">${game.prediction}</td>
            <td style="padding: 12px; border: 1px solid #ddd; background-color: ${background_color};">${game.winner}</td>
          `;
        }
        if (prediction == 'simulation') {
          newHTML += `
                      <td style="padding: 12px; border: 1px solid #ddd;">${game.confidence}</td>
                      <td style="padding: 12px; border: 1px solid #ddd;">${game.confidence_interval[0]}% - ${game.confidence_interval[1]}%</td>
          `;
        }

        row.innerHTML = newHTML;
        tbody.appendChild(row);

        total_games++;
      });
      

      table.appendChild(tbody);
      container.append(table);
      

    }
  }

  let draggedTeam;

 
  async function loadTeams(league) {
    try {
      const response = await fetch(`/get_teams?league=${league}`);
      const data = await response.json();

      const teamListColumn = document.getElementById('team-list-column');
      teamListColumn.innerHTML = ''; 

      data.teams.forEach(team => {
        const teamCard = document.createElement('div');
        teamCard.className = 'team-card';
        teamCard.draggable = true;
        teamCard.innerText = team;

   
        teamCard.addEventListener('dragstart', (e) => {
          draggedTeam = e.target.innerText;
        });

        teamListColumn.appendChild(teamCard);
      });
    } catch (error) {
      console.error("Failed to load teams:", error);
    }
  }


  loadTeams('NBA');


  document.getElementById('league-toggle').addEventListener('change', (e) => {
    const league = e.target.checked ? 'NCAAMB_D1' : 'NBA';
    loadTeams(league);
  });

  
  document.querySelectorAll(".drop-zone").forEach(zone => {
    zone.addEventListener("dragover", e => e.preventDefault());

    zone.addEventListener("drop", e => {
      e.preventDefault();
      const otherZoneId = zone.id === "team1-drop" ? "team2-drop" : "team1-drop";
      const otherZone = document.getElementById(otherZoneId);
      const otherTeamName = otherZone.innerText;

      if (otherTeamName === draggedTeam) {
        alert("Cannot select the same team twice.");
        return;
      }

      zone.innerText = draggedTeam;
      zone.style.backgroundColor = "rgba(255,255,255,0.8)";
    });
  });

  // Predict button handler
  


  function retrieveMatchups() {
    const date = document.getElementById("date-select").value;
    const team1 = document.getElementById("team1-drop").innerText.trim();
    const team2 = document.getElementById("team2-drop").innerText.trim();
    console.log(team1)
    console.log(team2)
    if (team1.toLowerCase().includes("drop") || team2.toLowerCase().includes("drop")) {
      alert("Please select two teams.");
      return;
    }
    if (team1 === team2) {
      alert("Please select two different teams.");
      return;
    }
    if (!date) {
      alert("Please select a date.");
      return;
    }
    
    fetch('/get_matchups', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      
      body: JSON.stringify({
  selected_date: date,
  team1: team1,
  team2: team2,
  selected_league: document.getElementById('league-toggle').checked ? 'NCAAMB1' : 'NBA'
})

    })

    
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("games-table-container");
      
      if (data.games.length === 0) {
        container.innerHTML = "<p>No games found.</p>";
        return;
      }

      let tableHTML = `
        <table style="
          width: 100%;
          border-collapse: collapse;
          font-family: 'Montserrat', sans-serif;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          margin-left: 50px;
        "
          id="games-table"
          class="game-table"
        >
          <caption style="font-weight: 600; font-size= 1em"> Season ${data.season}: Upcoming Games as of ${date}</caption>
          <thead>
            <tr style="background-color: #1D428A; color: white;">
              <th style="padding: 12px; border: 1px solid #ddd;">Date</th>
              <th style="padding: 12px; border: 1px solid #ddd;">Home</th>
              <th style="padding: 12px; border: 1px solid #ddd;">Home W–L</th>
              <th style="padding: 12px; border: 1px solid #ddd;">Away</th>
              
              <th style="padding: 12px; border: 1px solid #ddd;">Away W–L</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.games.forEach(game => {
        tableHTML += `
          <tr style="background-color: #f9f9f9;">
            <td style="padding: 12px; border: 1px solid #ddd;">${new Date(game.game_date).toLocaleDateString()}</td>
            <td id="${game.home_id}" style="padding: 12px; border: 1px solid #ddd;">${game.home}</td>
            <td style="padding: 12px; border: 1px solid #ddd;">${game.home_record}</td>
            <td id="${game.away_id}" style="padding: 12px; border: 1px solid #ddd;">${game.away}</td>
            
            <td id="${game.game_id}" style="padding: 12px; border: 1px solid #ddd;">${game.away_record}</td>
          </tr>
        `;
      });

      tableHTML += `</tbody></table>`;
      container.innerHTML = tableHTML;

      const confusionMatrix = document.getElementById('predictions-table-container')
      confusionMatrix.innerHTML = ''
      const statsTable = document.getElementById('stats-table-container')
      statsTable.innerHTML = ''
    })
    .catch(err => {
      console.error(err);
      alert("Failed to retrieve games.");
    });
  };

  function getGameTableInfo() {
  const table = document.getElementById("games-table");
  const tableData = {};
  const selectedGames = {};

  //changed
  const gameIds = [];


  if (!table) {
    console.warn("No table found.");
    return [tableData, selectedGames];
  }

  const rows = table.querySelectorAll('tbody tr');

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 5) return;

    
    const rawDate = new Date(cells[0].textContent.trim());
    rawDate.setDate(rawDate.getDate()+1);
    const gameDate = rawDate.toISOString().slice(0, 10);

    if (!selectedGames[gameDate]) selectedGames[gameDate] = [];
    if (!tableData[gameDate]) tableData[gameDate] = [];

    const homeId = parseInt(cells[1].id.replace(/\D/g, ''));
    const awayId = parseInt(cells[3].id.replace(/\D/g, ''));

    //changed
    const gameId = row.cells[4].id; // 5th cell (index 4) holds game_id
    console.log("hi");
    console.log(row.cells[4].id);
    gameIds.push(gameId); 

    selectedGames[gameDate].push(homeId, awayId);

    tableData[gameDate].push({
      home: cells[1].textContent.trim(),
      home_record: cells[2].textContent.trim(),
      away: cells[3].textContent.trim(),
      away_record: cells[4].textContent.trim(),
      home_id: cells[1].id,
      away_id: cells[3].id,
      id: row.id ? parseInt(row.id.replace(/\D/g, '')) : null
    });
  });
  console.log("hi");
  
  return [tableData, selectedGames, gameIds];
}




  function predictGames() {
    const startDateStr = document.getElementById("date-select").value;
  const league = document.getElementById('league-toggle').checked ? 'NCAAMB1' : 'NBA';
  const model = document.getElementById("model-select").value;
  const predButton = document.getElementById("predict-button");
  const team1 = document.getElementById("team1-drop").innerText.trim();
    const team2 = document.getElementById("team2-drop").innerText.trim();
  predButton.textContent = "Loading...";

if (!startDateStr) {
  alert('Please select a start date.');
  return;
}

const startDate = new Date(startDateStr);

// Set end date based on league
let endDateStr = league === 'NBA' ? '2025-06-22' : '2025-04-14';
const endDate = new Date(endDateStr);

if (endDate < startDate) {
  alert(`For ${league}, the end of the season is ${endDateStr}. Please choose an earlier start date.`);
  return;
}

// Generate date range
const diffDays = (endDate - startDate) / (1000 * 3600 * 24) + 1;
const dates = [];
for (let i = 0; i < diffDays; i++) {
  const d = new Date(startDate);
  d.setDate(startDate.getDate() + i);
  dates.push(d.toISOString().slice(0, 10));
}


let [tableData, selectedGames, gameIds] = getGameTableInfo();
    if (Object.keys(selectedGames).length == 0) {
      predButton.textContent = "PREDICT";
      alert("No games selected");
      return;
    }
    

    fetch('/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ selected_games: selectedGames, selected_league: league, selected_model: model, selected_gameIds:gameIds })
    })
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('games-table-container');
      if (!data.games || Object.keys(data.games).length === 0) {
        container.innerHTML = '<p>No predictions available.</p>';
        predButton.textContent = "PREDICT";
        return;
      }
      
      for (const [date, games] of Object.entries(data.games)) {
        let i = 0;
        games.forEach( game => {
          tableData[date][i]['prediction'] = game[0];
          tableData[date][i]['winner'] = game[1];
          if (model == 'simulation') {
            tableData[date][i]['confidence'] = game[2];
            tableData[date][i]['confidence_interval'] = game[3];
          }
          i++;
        });
      }

      const renderData = {'games': tableData}
      renderGameTable(renderData, model);

      predButton.textContent = "PREDICT";
      const confusionMatrix = document.getElementById('predictions-table-container');
      confusionMatrix.innerHTML = `
        <table style="
          width: 100%;
          border-collapse: collapse;
          font-family: 'Montserrat', sans-serif;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        "
          id="games-table"
        >
          <caption style="font-weight: 600; font-size= 1em"> Confusion Matrix </caption>
          <thead>
            <tr style="background-color: #1D428A; color: white;">
              <td style="background-color: #f9f9f9;"></td>
              <th style="padding: 12px; border: 1px solid #ddd;">Predicted Home Win</th>
              <th style="padding: 12px; border: 1px solid #ddd;">Predicted Home Loss</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background-color: #1D428A;">
              <th style="padding: 12px; border: 1px solid #ddd;  color: white;">Actual Home Win</th>
              <td style="padding: 12px; border: 1px solid #ddd; background-color: #f9f9f9;">${data.confusion_matrix[0][0]}</td>
              <td style="padding: 12px; border: 1px solid #ddd; background-color: #f9f9f9;">${data.confusion_matrix[0][1]}</td>
            </tr>
            <tr style="background-color: #1D428A;">
              <th style="padding: 12px; border: 1px solid #ddd;  color: white;">Actual Home Loss</th>
              <td style="padding: 12px; border: 1px solid #ddd; background-color: #f9f9f9;">${data.confusion_matrix[1][0]}</td>
              <td style="padding: 12px; border: 1px solid #ddd; background-color: #f9f9f9;">${data.confusion_matrix[1][1]}</td>
            </tr>
          </tbody>
      `;
      
      const statsTable = document.getElementById('stats-table-container');
      statsTable.innerHTML = `
        <table style="
          width: 100%;
          border-collapse: collapse;
          font-family: 'Montserrat', sans-serif;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        "
          id="games-table"
        >
          <caption style="font-weight: 600; font-size= 1em"> Prediction Stats </caption>
          <thead>
            <tr style="background-color: #1D428A; color: white;">
              <th style="padding: 12px; border: 1px solid #ddd;">Accuracy %</th>
              <th style="padding: 12px; border: 1px solid #ddd;">Recall %</th>
              <th style="padding: 12px; border: 1px solid #ddd;">Precision %</th>
              <th style="padding: 12px; border: 1px solid #ddd;">F1</th>
            </tr>
          </thead>

          <tbody>
            <tr style="background-color: #f9f9f9;">
              <td style="padding: 12px; border: 1px solid #ddd;">${data.stats.final_acc}%</td>
              <td style="padding: 12px; border: 1px solid #ddd;">${data.stats.final_recall}%</td>
              <td style="padding: 12px; border: 1px solid #ddd;">${data.stats.final_precision}%</td>
              <td style="padding: 12px; border: 1px solid #ddd;">${data.stats.final_f1}</td>
            </tr>
          </tbody>
      `;
      

      
    })
    .catch(err => {
      predButton.textContent = "PREDICT"
      console.error(err);
      alert('Failed to retrieve predictions.');
    });
  }
</script>

{% endblock %}
